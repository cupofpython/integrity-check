name: 'Verify Chainguard Base Image'
description: 'Runs cosign verify on all base images found in a Dockerfile'
author: 'Sam Morris'

inputs:
  dockerfile:
    description: 'Path to the Dockerfile'
    required: false
    default: 'Dockerfile'
  policy-file:
    description: 'Path to the image policy JSON file'
    required: false
    default: 'image-policy.json'

runs:
  using: 'composite'
  steps:
    - name: Install cosign
      uses: sigstore/cosign-installer@v3

    - name: Verify all base images with cosign
      shell: bash
      run: |
        DOCKERFILE="${{ inputs.dockerfile }}"
        POLICY_FILE="${{ inputs.policy-file }}"
        POLICY_COUNT=$(jq '.policies | length' "$POLICY_FILE")

        grep -i '^FROM' "$DOCKERFILE" \
          | awk '{print $2}' \
          | grep -v 'scratch' \
          | grep -v '^\$' \
          | sort -u \
          | while read -r image; do
              echo "Verifying: $image"
              IMAGE_VERIFIED=false

              for i in $(seq 0 $((POLICY_COUNT - 1))); do
                POLICY_NAME=$(jq -r ".policies[$i].name" "$POLICY_FILE")
                ISSUER=$(jq -r ".policies[$i].oidc_issuer" "$POLICY_FILE")
                IDENTITY=$(jq -r ".policies[$i].certificate_identity" "$POLICY_FILE")

                echo "  Trying policy: $POLICY_NAME"
                if cosign verify \
                  --certificate-oidc-issuer="$ISSUER" \
                  --certificate-identity="$IDENTITY" \
                  "$image" | jq; then
                  IMAGE_VERIFIED=true
                  break
                fi
              done

              if [ "$IMAGE_VERIFIED" = false ]; then
                echo "❌ $image failed all policies"
                exit 1
              fi

              echo "✅ $image verified"
            done